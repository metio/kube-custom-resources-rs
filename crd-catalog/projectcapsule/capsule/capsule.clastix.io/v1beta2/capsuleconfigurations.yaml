apiVersion: "apiextensions.k8s.io/v1"
kind: "CustomResourceDefinition"
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: "v0.20.0"
  name: "capsuleconfigurations.capsule.clastix.io"
spec:
  group: "capsule.clastix.io"
  names:
    kind: "CapsuleConfiguration"
    listKind: "CapsuleConfigurationList"
    plural: "capsuleconfigurations"
    singular: "capsuleconfiguration"
  scope: "Cluster"
  versions:
    - name: "v1beta2"
      schema:
        openAPIV3Schema:
          description: "CapsuleConfiguration is the Schema for the Capsule configuration API."
          properties:
            apiVersion:
              description: "APIVersion defines the versioned schema of this representation of an object.\nServers should convert recognized schemas to the latest internal value, and\nmay reject unrecognized values.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources"
              type: "string"
            kind:
              description: "Kind is a string value representing the REST resource this object represents.\nServers may infer this from the endpoint the client submits requests to.\nCannot be updated.\nIn CamelCase.\nMore info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds"
              type: "string"
            metadata:
              type: "object"
            spec:
              description: "CapsuleConfigurationSpec defines the Capsule configuration."
              properties:
                administrators:
                  description: "Define entities which can act as Administrators in the capsule construct\nThese entities are automatically owners for all existing tenants. Meaning they can add namespaces to any tenant. However they must be specific by using the capsule label\nfor interacting with namespaces. Because if that label is not defined, it's assumed that namespace interaction was not targeted towards a tenant and will therefor\nbe ignored by capsule."
                  items:
                    properties:
                      kind:
                        description: "Kind of entity. Possible values are \"User\", \"Group\", and \"ServiceAccount\""
                        enum:
                          - "User"
                          - "Group"
                          - "ServiceAccount"
                        type: "string"
                      name:
                        description: "Name of the entity."
                        type: "string"
                    required:
                      - "kind"
                      - "name"
                    type: "object"
                  type: "array"
                admission:
                  description: "Configuration for dynamic Validating and Mutating Admission webhooks managed by Capsule."
                  properties:
                    mutating:
                      description: "Configure dynamic Mutating Admission for Capsule"
                      properties:
                        annotations:
                          additionalProperties:
                            type: "string"
                          description: "Annotations added to the Admission Webhook"
                          type: "object"
                        client:
                          description: "From the upstram struct"
                          properties:
                            caBundle:
                              description: "`caBundle` is a PEM encoded CA bundle which will be used to validate the webhook's server certificate.\nIf unspecified, system trust roots on the apiserver are used."
                              format: "byte"
                              type: "string"
                            service:
                              description: "`service` is a reference to the service for this webhook. Either\n`service` or `url` must be specified.\n\nIf the webhook is running within the cluster, then you should use `service`."
                              properties:
                                name:
                                  description: "`name` is the name of the service.\nRequired"
                                  type: "string"
                                namespace:
                                  description: "`namespace` is the namespace of the service.\nRequired"
                                  type: "string"
                                path:
                                  description: "`path` is an optional URL path which will be sent in any request to\nthis service."
                                  type: "string"
                                port:
                                  description: "If specified, the port on the service that hosting webhook.\nDefault to 443 for backward compatibility.\n`port` should be a valid port number (1-65535, inclusive)."
                                  format: "int32"
                                  type: "integer"
                              required:
                                - "name"
                                - "namespace"
                              type: "object"
                            url:
                              description: "`url` gives the location of the webhook, in standard URL form\n(`scheme://host:port/path`). Exactly one of `url` or `service`\nmust be specified.\n\nThe `host` should not refer to a service running in the cluster; use\nthe `service` field instead. The host might be resolved via external\nDNS in some apiservers (e.g., `kube-apiserver` cannot resolve\nin-cluster DNS as that would be a layering violation). `host` may\nalso be an IP address.\n\nPlease note that using `localhost` or `127.0.0.1` as a `host` is\nrisky unless you take great care to run this webhook on all hosts\nwhich run an apiserver which might need to make calls to this\nwebhook. Such installs are likely to be non-portable, i.e., not easy\nto turn up in a new cluster.\n\nThe scheme must be \"https\"; the URL must begin with \"https://\".\n\nA path is optional, and if present may be any string permissible in\na URL. You may use the path to pass an arbitrary string to the\nwebhook, for example, a cluster identifier.\n\nAttempting to use a user or basic auth e.g. \"user:password@\" is not\nallowed. Fragments (\"#...\") and query parameters (\"?...\") are not\nallowed, either."
                              type: "string"
                          type: "object"
                        labels:
                          additionalProperties:
                            type: "string"
                          description: "Labels added to the Admission Webhook"
                          type: "object"
                        name:
                          description: "Name the Admission Webhook"
                          maxLength: 253
                          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
                          type: "string"
                      required:
                        - "client"
                      type: "object"
                    validating:
                      description: "Configure dynamic Validating Admission for Capsule"
                      properties:
                        annotations:
                          additionalProperties:
                            type: "string"
                          description: "Annotations added to the Admission Webhook"
                          type: "object"
                        client:
                          description: "From the upstram struct"
                          properties:
                            caBundle:
                              description: "`caBundle` is a PEM encoded CA bundle which will be used to validate the webhook's server certificate.\nIf unspecified, system trust roots on the apiserver are used."
                              format: "byte"
                              type: "string"
                            service:
                              description: "`service` is a reference to the service for this webhook. Either\n`service` or `url` must be specified.\n\nIf the webhook is running within the cluster, then you should use `service`."
                              properties:
                                name:
                                  description: "`name` is the name of the service.\nRequired"
                                  type: "string"
                                namespace:
                                  description: "`namespace` is the namespace of the service.\nRequired"
                                  type: "string"
                                path:
                                  description: "`path` is an optional URL path which will be sent in any request to\nthis service."
                                  type: "string"
                                port:
                                  description: "If specified, the port on the service that hosting webhook.\nDefault to 443 for backward compatibility.\n`port` should be a valid port number (1-65535, inclusive)."
                                  format: "int32"
                                  type: "integer"
                              required:
                                - "name"
                                - "namespace"
                              type: "object"
                            url:
                              description: "`url` gives the location of the webhook, in standard URL form\n(`scheme://host:port/path`). Exactly one of `url` or `service`\nmust be specified.\n\nThe `host` should not refer to a service running in the cluster; use\nthe `service` field instead. The host might be resolved via external\nDNS in some apiservers (e.g., `kube-apiserver` cannot resolve\nin-cluster DNS as that would be a layering violation). `host` may\nalso be an IP address.\n\nPlease note that using `localhost` or `127.0.0.1` as a `host` is\nrisky unless you take great care to run this webhook on all hosts\nwhich run an apiserver which might need to make calls to this\nwebhook. Such installs are likely to be non-portable, i.e., not easy\nto turn up in a new cluster.\n\nThe scheme must be \"https\"; the URL must begin with \"https://\".\n\nA path is optional, and if present may be any string permissible in\na URL. You may use the path to pass an arbitrary string to the\nwebhook, for example, a cluster identifier.\n\nAttempting to use a user or basic auth e.g. \"user:password@\" is not\nallowed. Fragments (\"#...\") and query parameters (\"?...\") are not\nallowed, either."
                              type: "string"
                          type: "object"
                        labels:
                          additionalProperties:
                            type: "string"
                          description: "Labels added to the Admission Webhook"
                          type: "object"
                        name:
                          description: "Name the Admission Webhook"
                          maxLength: 253
                          pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
                          type: "string"
                      required:
                        - "client"
                      type: "object"
                  type: "object"
                allowServiceAccountPromotion:
                  default: false
                  description: "ServiceAccounts within tenant namespaces can be promoted to owners of the given tenant\nthis can be achieved by labeling the serviceaccount and then they are considered owners. This can only be done by other owners of the tenant.\nHowever ServiceAccounts which have been promoted to owner can not promote further serviceAccounts."
                  type: "boolean"
                cacheInvalidation:
                  default: "24h"
                  description: "Define the period of time upon a cache invalidation is executed for all caches."
                  type: "string"
                enableTLSReconciler:
                  default: false
                  description: "Toggles the TLS reconciler, the controller that is able to generate CA and certificates for the webhooks\nwhen not using an already provided CA and certificate, or when these are managed externally with Vault, or cert-manager."
                  type: "boolean"
                forceTenantPrefix:
                  default: false
                  description: "Enforces the Tenant owner, during Namespace creation, to name it using the selected Tenant name as prefix,\nseparated by a dash. This is useful to avoid Namespace name collision in a public CaaS environment."
                  type: "boolean"
                ignoreUserWithGroups:
                  description: "Define groups which when found in the request of a user will be ignored by the Capsule\nthis might be useful if you have one group where all the users are in, but you want to separate administrators from normal users with additional groups."
                  items:
                    type: "string"
                  type: "array"
                nodeMetadata:
                  description: "Allows to set the forbidden metadata for the worker nodes that could be patched by a Tenant.\nThis applies only if the Tenant has an active NodeSelector, and the Owner have right to patch their nodes."
                  properties:
                    forbiddenAnnotations:
                      description: "Define the annotations that a Tenant Owner cannot set for their nodes."
                      properties:
                        denied:
                          items:
                            type: "string"
                          type: "array"
                        deniedRegex:
                          type: "string"
                      type: "object"
                    forbiddenLabels:
                      description: "Define the labels that a Tenant Owner cannot set for their nodes."
                      properties:
                        denied:
                          items:
                            type: "string"
                          type: "array"
                        deniedRegex:
                          type: "string"
                      type: "object"
                  type: "object"
                overrides:
                  default:
                    TLSSecretName: "capsule-tls"
                    mutatingWebhookConfigurationName: "capsule-mutating-webhook-configuration"
                    validatingWebhookConfigurationName: "capsule-validating-webhook-configuration"
                  description: "Allows to set different name rather than the canonical one for the Capsule configuration objects,\nsuch as webhook secret or configurations."
                  properties:
                    TLSSecretName:
                      default: "capsule-tls"
                      description: "Defines the Secret name used for the webhook server.\nMust be in the same Namespace where the Capsule Deployment is deployed."
                      type: "string"
                    mutatingWebhookConfigurationName:
                      default: "capsule-mutating-webhook-configuration"
                      description: "Name of the MutatingWebhookConfiguration which contains the dynamic admission controller paths and resources."
                      type: "string"
                    validatingWebhookConfigurationName:
                      default: "capsule-validating-webhook-configuration"
                      description: "Name of the ValidatingWebhookConfiguration which contains the dynamic admission controller paths and resources."
                      type: "string"
                  required:
                    - "TLSSecretName"
                    - "mutatingWebhookConfigurationName"
                    - "validatingWebhookConfigurationName"
                  type: "object"
                protectedNamespaceRegex:
                  description: "Disallow creation of namespaces, whose name matches this regexp"
                  type: "string"
                rbac:
                  default: {}
                  description: "Define Properties for managed ClusterRoles by Capsule"
                  properties:
                    administrationClusterRoles:
                      default:
                        - "capsule-namespace-deleter"
                      description: "The ClusterRoles applied for Administrators"
                      items:
                        type: "string"
                      type: "array"
                    deleter:
                      default: "capsule-namespace-deleter"
                      description: "Name for the ClusterRole required to grant Namespace Deletion permissions."
                      type: "string"
                    promotionClusterRoles:
                      default:
                        - "capsule-namespace-provisioner"
                        - "capsule-namespace-deleter"
                      description: "The ClusterRoles applied for ServiceAccounts which had owner Promotion"
                      items:
                        type: "string"
                      type: "array"
                    provisioner:
                      default: "capsule-namespace-provisioner"
                      description: "Name for the ClusterRole required to grant Namespace Provision permissions."
                      type: "string"
                  type: "object"
                userGroups:
                  description: "Deprecated: use users property instead (https://projectcapsule.dev/docs/operating/setup/configuration/#users)\n\nNames of the groups considered as Capsule users."
                  items:
                    type: "string"
                  type: "array"
                userNames:
                  description: "Deprecated: use users property instead (https://projectcapsule.dev/docs/operating/setup/configuration/#users)\n\nNames of the users considered as Capsule users."
                  items:
                    type: "string"
                  type: "array"
                users:
                  description: "Define entities which are considered part of the Capsule construct\nUsers not mentioned here will be ignored by Capsule"
                  items:
                    properties:
                      kind:
                        description: "Kind of entity. Possible values are \"User\", \"Group\", and \"ServiceAccount\""
                        enum:
                          - "User"
                          - "Group"
                          - "ServiceAccount"
                        type: "string"
                      name:
                        description: "Name of the entity."
                        type: "string"
                    required:
                      - "kind"
                      - "name"
                    type: "object"
                  type: "array"
              required:
                - "cacheInvalidation"
                - "enableTLSReconciler"
                - "rbac"
              type: "object"
            status:
              description: "CapsuleConfigurationStatus defines the Capsule configuration status."
              properties:
                lastCacheInvalidation:
                  description: "Last time all caches were invalided"
                  format: "date-time"
                  type: "string"
                users:
                  description: "Users which are considered Capsule Users and are bound to the Capsule Tenant construct."
                  items:
                    properties:
                      kind:
                        description: "Kind of entity. Possible values are \"User\", \"Group\", and \"ServiceAccount\""
                        enum:
                          - "User"
                          - "Group"
                          - "ServiceAccount"
                        type: "string"
                      name:
                        description: "Name of the entity."
                        type: "string"
                    required:
                      - "kind"
                      - "name"
                    type: "object"
                  type: "array"
              type: "object"
          required:
            - "spec"
          type: "object"
      served: true
      storage: true
      subresources:
        status: {}
